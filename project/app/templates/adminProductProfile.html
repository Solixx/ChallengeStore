{% extends "adminBase.html" %} 
{% block title %} Admin Panel | Challenge Store {% endblock %} 
{% block content %}
  <div class="container">
    <h1 class="col12">Product</h1>
    <form id="updateForm" enctype="multipart/form-data" onSubmit="sendForm({{product.id}})">
      {% csrf_token %}
      <div class="col12">
        <label for="name">Name</label>
        <input type="text" id="name" name="name" value="{{ product.name }}">
      </div>
      <div class="col12">
        <label for="price">Price</label>
        <input type="number" id="price" name="price" value="{{ product.price }}">
      </div>
      <div class="col12">
        <label for="stock">Stock</label>
        <input type="number" id="stock" name="stock" value="{{ product.stock }}">
      </div>
      <div class="col12">
        <label for="image">Image</label>
        <input type="file" id="image" name="image">
        
        <div style="display: flex; flex-direction: row; align-items: flex-end; gap: 20px; margin: 50px 0; width: 540px; height: 300px">
          <img id="img-preview-50" src="{% if product.image %}{{ product.image.url }} {% endif %}" alt="Current Image" style="width: 50px !important; height: 50px !important">
          <img id="img-preview-150" src="{% if product.image %}{{ product.image.url }} {% endif %}" alt="Current Image" style="width: 150px !important; height: 150px !important">
          <img id="img-preview-300" src="{% if product.image %}{{ product.image.url }} {% endif %}" alt="Current Image" style="width: 300px !important; height: 300px !important">
        </div>
        
      </div>
      <div class="col12">
        <label for="stock">Category</label>
        <select id="category" name="category" required value="product.category_id">
          {% for category in categories %}
            <option value="{{ category.id }}" {% if category.id == product.category_id %}selected{% endif %} {% if category.is_deleted %}disabled{% endif %}>{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col12">
        <button>
          Edit
        </button>
      </div>
    </form>
    <ul class="col12">
        <li id="productNamePrice"></li>
        <li id="productStock"></li>
        {% if product.image %}
          <li><img id="displayImage" src="" alt="" /></li>
        {% endif %}
    </ul>
    <div class="col12">
        {% if product.is_deleted %}
          <a class="adminProductContentButtonActive" href="{% url 'adminProductRestore' product.id %}">
            <button>
              Restore
            </button>
          </a>
        {% else %}
          <a class="adminProductContentButtonDisable" href="{% url 'adminProductDelete' product.id %}">
            <button>
              Delete
            </button>
          </a>
        {% endif %}
    </div>
  </div>

<script>
  productJS = {}
  const imageInput = document.getElementById('image');
  imageInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const newSrc = e.target.result;
        updatePreviewImages(newSrc)
      };
      
      // Read the selected image as a DataURL
      reader.readAsDataURL(file);
    } else{
      updatePreviewImages(productJS.image_url)
    }
  });

  var sendForm = (id) => {
    event.preventDefault()
    var form = document.getElementById("updateForm");
    var formData = new FormData(form);
    
    fetch('http://127.0.0.1:8000/adminPanel/products/edit/'+id+'/', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      updateProductJS(data)
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  }

  var disableProd = (id) => {
    event.preventDefault()
    var form = document.getElementById("disableForm");
    var formData = new FormData(form);

    fetch('http://127.0.0.1:8000/adminPanel/products/delete/'+id+'/', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      updateProductJS(data)
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  }

  var restoreProd = (id) => {
    event.preventDefault()
    var form = document.getElementById("restoreForm");
    var formData = new FormData(form);

    fetch('http://127.0.0.1:8000/adminPanel/products/restore/'+id+'/', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      updateProductJS(data)
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  }

  var startValues = () => {
    productJS = {}
    productJS.id = {{ product.id }};
    productJS.name = "{{ product.name }}";
    productJS.price = {{ product.price }};
    productJS.stock = {{ product.stock }};
    productJS.image_name = "{{ product.image.name }}";
    productJS.image_url = "{{ product.image.url }}";
    productJS.category_id = {{ product.category_id }};
    productJS.is_deleted = "{{ product.is_deleted }}";
    
    insertHtmlContent()
  }

  var insertHtmlContent = () => {
    document.getElementById('productNamePrice').innerHTML = productJS.name + ' - $' + productJS.price;
    document.getElementById('productStock').innerHTML = productJS.stock;
    document.getElementById('displayImage').src = productJS.image_url;
  }

  var updateProductJS = (data) => {
    productJS = data.product

    categoriesArray = JSON.parse(data.categories)
    categories = categoriesArray.map((cat) => {
      category = cat.fields
      category.id = cat.pk
      return category
    })

    insertHtmlContent()
  }

  var updatePreviewImages = (newSrc) => {
    const img50 = document.getElementById('img-preview-50');
      const img150 = document.getElementById('img-preview-150');
      const img300 = document.getElementById('img-preview-300');
        
      if (img50) img50.src = newSrc;
      if (img150) img150.src = newSrc;
      if (img300) img300.src = newSrc;
  }

  startValues()
</script>
{% endblock %}
